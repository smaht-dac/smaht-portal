import React from 'react';
import _ from 'underscore';

import { valueTransforms } from '@hms-dbmi-bgm/shared-portal-components/es/components/util';
import { SelectionItemCheckbox } from '@hms-dbmi-bgm/shared-portal-components/es/components/browse/components/SelectedItemsController';

import { EmbeddedItemSearchTable } from '../../../item-pages/components/EmbeddedItemSearchTable';
import { TableControllerWithSelections } from '../TableControllerWithSelections';
import { BenchmarkingAboveTableComponent } from '../benchmarking/BenchmarkingTable';
import { SelectAllFilesButton } from '../SelectAllAboveTableComponent';

export const ChallengeTableWrapper = (props) => {
    const { searchHref, schemas, facets, session, href, context } = props;
    return (
        <TableControllerWithSelections
            {...{ searchHref, schemas, facets, session, href, context }}>
            <ChallengeTable />
        </TableControllerWithSelections>
    );
};

const ChallengeTable = (props) => {
    const {
        searchHref,
        schemas,
        facets,
        session,
        href,
        columnExtensionMap: originalColExtMap,
        selectedItems, // From SelectedItemsController
        onSelectItem, // From SelectedItemsController
        onResetSelectedItems, // From SelectedItemsController
    } = props;

    const selectedFileProps = {
        selectedItems, // From SelectedItemsController
        onSelectItem, // From SelectedItemsController
        onResetSelectedItems, // From SelectedItemsController
    };

    /**
     * A column extension map speifically for benchmarking tables.
     * Some of these things may be worth moving to the global colextmap eventually.
     */
    const benchmarkingColExtMap = {
        ...originalColExtMap, // Pull in defaults for all tables
        // Then overwrite or add onto the ones that already are there:
        // Select all button
        '@type': {
            colTitle: (
                // Context now passed in from HeadersRowColumn (for file count)
                <SelectAllFilesButton {...selectedFileProps} type="checkbox" />
            ),
            hideTooltip: true,
            noSort: true,
            widthMap: { lg: 63, md: 63, sm: 63 },
            render: (result, parentProps) => {
                return (
                    <SelectionItemCheckbox
                        {...{ selectedItems, onSelectItem, result }}
                        isMultiSelect={true}
                    />
                );
            },
        },
        // File
        annotated_filename: {
            widthMap: { lg: 500, md: 400, sm: 300 },
            render: function (result, parentProps) {
                const {
                    '@id': atId,
                    display_title,
                    annotated_filename,
                } = result || {};

                return (
                    <span className="value text-left">
                        <a
                            href={atId}
                            target="_blank"
                            rel="noreferrer noopener">
                            {annotated_filename || display_title}
                        </a>
                    </span>
                );
            },
        },
        // File Size
        file_size: {
            widthMap: { lg: 105, md: 100, sm: 100 },
            render: function (result, parentProps) {
                const value = result?.file_size;
                if (!value) return null;
                return (
                    <span className="value text-right">
                        {valueTransforms.bytesToLargerUnit(value)}
                    </span>
                );
            },
        },
        // HIDE DEFAULT COLUMNS from File:
        // Assay
        'file_sets.assay.display_title': { disabled: true },
        // Platform
        'file_sets.sequencing.sequencer.display_title': { disabled: true },
        // Sequencing Center
        'sequencing_center.display_title': { disabled: true },
        // Method
        'software.display_title': { disabled: true },
        // Submission Date
        date_created: { disabled: true },
        // Format
        'file_format.display_title': { disabled: true },
        // Generated By
        'submission_centers.display_title': { disabled: true },
        // Access
        access_status: { disabled: true },
        // Data Category
        data_type: { disabled: true },
    };

    return (
        <EmbeddedItemSearchTable
            key={session}
            embeddedTableHeader={
                <BenchmarkingAboveTableComponent
                    {...{
                        session,
                        selectedItems,
                        onSelectItem,
                        onResetSelectedItems,
                        href,
                        searchHref,
                    }}
                />
            }
            rowHeight={31}
            // maxHeight={200}
            {...{
                searchHref,
                schemas,
                session,
                facets,
                selectedItems,
                onSelectItem,
                onResetSelectedItems,
            }}
            columnExtensionMap={benchmarkingColExtMap}
            hideFacets={[
                'dataset',
                'file_sets.libraries.analytes.samples.sample_sources.code',
                'status',
                'validation-errors.name',
            ]}
            hideColumns={['display_title']}
            clearSelectedItemsOnFilter
        />
    );
};
