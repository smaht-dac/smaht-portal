'use strict';

import React, { useEffect, useState } from 'react';
import {
    bytesToLargerUnit,
    capitalize,
    capitalizeSentence,
} from '@hms-dbmi-bgm/shared-portal-components/es/components/util/value-transforms';
import { LocalizedTime } from '@hms-dbmi-bgm/shared-portal-components/es/components/ui/LocalizedTime';

import {
    OverlayTrigger,
    Popover,
    PopoverHeader,
    PopoverBody,
} from 'react-bootstrap';
import { DataCard, DataCardRow } from '../file-overview/FileViewDataCards';
import { ajax } from '@hms-dbmi-bgm/shared-portal-components/es/components/util';

/**
 * Below are arrays of file property objects with `title` and `getProp`, a
 * function for extracting the property's value (if available) from `context`.
 * Used to populate the data cards in the FileViewDataCards component.
 */
const default_file_properties = [
    {
        title: 'Status',
        getProp: (context = {}) => (
            <>
                <i
                    className="status-indicator-dot me-07"
                    data-status={context?.status}
                />
                {capitalizeSentence(context?.status)}
            </>
        ),
    },
    {
        title: 'Annotated Name',
        getProp: (context = {}) =>
            context?.annotated_filename ?? context?.filename,
    },
    { title: 'Access', getProp: (context = {}) => context?.access_status },
    { title: 'UUID', getProp: (context = {}) => context?.uuid },
    {
        title: 'Data Format',
        getProp: (context = {}) => context?.file_format?.display_title,
    },
    {
        title: 'Size',
        getProp: (context = {}) => {
            const fileSize = context?.file_summary?.file_size;
            if (fileSize) {
                return bytesToLargerUnit(fileSize);
            } else {
                return null;
            }
        },
    },
    {
        title: 'MD5 Checksum',
        getProp: (context = {}) => context?.content_md5sum || context?.md5sum,
    },
    {
        title: 'Public Release Date',
        getProp: (context = {}) => {
            return context?.file_status_tracking?.released ? (
                <LocalizedTime
                    timestamp={context?.file_status_tracking.released}
                    formatType="date-md"
                    dateTimeSeparator=" "
                />
            ) : null;
        },
    },
];
const default_data_information = [
    {
        title: 'Data Category',
        getProp: (context = {}) =>
            context?.data_generation_summary?.data_category?.join(', '),
    },
    {
        title: 'Data Type',
        getProp: (context = {}) =>
            context?.data_generation_summary?.data_type?.join(', '),
    },
    {
        title: 'Sequencing Center',
        getProp: (context = {}) =>
            context?.data_generation_summary?.sequencing_center,
    },
    {
        title: 'Generated By',
        getProp: (context = {}) =>
            context?.data_generation_summary?.submission_centers?.join(', '),
    },
    {
        title: 'Experimental Assay',
        getProp: (context = {}) =>
            context?.data_generation_summary?.assays?.join(', '),
    },
    {
        title: 'Sequencing Platform',
        getProp: (context = {}) =>
            context?.data_generation_summary?.sequencing_platforms?.join(', '),
    },
    {
        title: 'Dataset Target Coverage',
        getProp: (context = {}) => {
            if (
                context?.file_format?.display_title === 'bam' &&
                context?.data_type.some((d) => d === 'Aligned Reads') &&
                context?.data_generation_summary?.assays?.some(
                    (assay) =>
                        assay.includes('WGS') ||
                        assay.includes('Fiber-seq') ||
                        assay.includes('Hi-C')
                )
            ) {
                const cov =
                    context?.data_generation_summary?.target_group_coverage;
                if (cov && cov.length > 0) {
                    return cov[0] + 'X';
                }
            }
            return null;
        },
    },
    {
        title: 'Dataset Target Read Count',
        getProp: (context = {}) => {
            if (
                context?.file_format?.display_title === 'bam' &&
                context?.data_type.some((d) => d === 'Aligned Reads') &&
                context?.data_generation_summary?.assays?.some(
                    (assay) =>
                        assay.includes('RNA-Seq') ||
                        assay.includes('MAS-ISO-Seq')
                )
            ) {
                const count =
                    context?.data_generation_summary?.target_read_count;
                if (count && count.length > 0) {
                    return count[0];
                }
            }
            return null;
        },
    },
];

const default_donor_information = [
    {
        title: 'Donor ID',
        getProp: (context = {}) => context?.external_id,
    },
    {
        title: 'Age',
        getProp: (context = {}) => context?.age,
    },
    {
        title: 'Sex',
        getProp: (context = {}) => context?.sex,
    },
    {
        title: 'Hardy Scale',
        getProp: (context = {}) => context?.hardy_scale,
    },
];

const default_data_summary = [
    {
        title: 'Donor ID',
        getProp: (context = {}) => context?.external_id,
    },
];

const DonorStatistics = ({ context, fileSearchURL = '' }) => {
    const [statisticValues, setStatisticValues] = useState({
        tissues: context?.tissues?.length,
        assays: null,
        files: null,
    });

    // Load the files from the search URL and calculate statistics
    useEffect(() => {
        // load value from searchUrl if not provided
        ajax.load(
            fileSearchURL,
            (resp) => {
                console.log('File Search Response:', resp);
                setStatisticValues({
                    ...statisticValues,
                    assays: resp?.facets
                        ?.find(
                            (facet) =>
                                facet.field ===
                                'file_sets.libraries.assay.display_title'
                        )
                        ?.original_terms.reduce((acc, t) => {
                            return acc + t.doc_count;
                        }, 0),
                    files: resp['@graph']?.length,
                });
            },
            'GET'
        );
    }, []);

    return (
        <div className="data-summary d-flex flex-column gap-3">
            <div className="d-flex gap-3">
                <div className="donor-statistic tissues d-flex flex-column p-2 gap-2">
                    <div className="donor-statistic-label text-center">
                        <i className="icon icon-lungs fas"></i>Tissues
                    </div>
                    <div className="donor-statistic-value text-center">
                        {statisticValues?.tissues ? (
                            <span>{statisticValues.tissues}</span>
                        ) : (
                            <i className="icon icon-circle-notch icon-spin fas" />
                        )}
                    </div>
                </div>
                <div className="donor-statistic assays d-flex flex-column p-2 gap-2">
                    <div className="donor-statistic-label text-center">
                        <i className="icon icon-dna fas"></i>Assays
                    </div>
                    <div className="donor-statistic-value text-center">
                        {statisticValues?.assays ? (
                            <span>{statisticValues.assays}</span>
                        ) : (
                            <i className="icon icon-circle-notch icon-spin fas" />
                        )}
                    </div>
                </div>
                <div className="donor-statistic files d-flex flex-column p-2 gap-2">
                    <div className="donor-statistic-label text-center">
                        <i className="icon icon-file fas"></i>Files
                    </div>
                    <div className="donor-statistic-value text-center">
                        {statisticValues?.files ? (
                            <span>{statisticValues?.files}</span>
                        ) : (
                            <i className="icon icon-circle-notch icon-spin fas" />
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

/**
 * Parent component for the data cards containing information on the file.
 * @param {object} context the context of the item being viewed
 */
export const DonorViewDataCards = ({ context = {} }) => {
    let donor_information = default_donor_information;
    console.log('DonorViewDataCards context:', context);

    return (
        <div className="data-cards-container d-flex flex-column">
            <div className="cards-left d-flex gap-4 flex-wrap">
                {/* Data Summary Card */}
                <div className="data-card">
                    <div className="header">
                        <span className="header-text">Data Summary</span>
                    </div>
                    <div className="body">
                        <div className="data-card-section">
                            <span className="section-title">
                                Donor Overview
                            </span>
                            <div className="section-body split d-flex mb-2">
                                <div className="d-flex flex-column">
                                    {donor_information.map(
                                        ({ title, getProp }) => {
                                            return (
                                                <DataCardRow
                                                    key={title}
                                                    title={title}
                                                    value={getProp(context)}
                                                />
                                            );
                                        }
                                    )}
                                </div>
                                <div className="d-flex flex-column">
                                    <DataCardRow title={'Tier'} />
                                    <DataCardRow title={'Bulk WGS Coverage'} />
                                    <DataCardRow title={'DSA'} />
                                </div>
                            </div>
                        </div>
                        <DonorStatistics
                            context={context}
                            fileSearchURL={`/search/?type=File&donors.display_title=${context?.display_title}`}
                        />
                    </div>
                </div>

                {/* Prior Diagnosis Card */}
                <div className="data-card prior-diagnosis">
                    <div className="header">
                        <div className="header-text">Prior Diagnosis</div>
                    </div>
                    <div className="body d-flex flex-column gap-4">
                        <div className="data-card-section">
                            <span className="section-title">
                                Cancer History
                            </span>
                            <div className="section-body">
                                <span className="">Prostate Cancer</span>
                            </div>
                        </div>
                        <div className="data-card-section">
                            <span className="section-title">
                                Family Cancer History
                            </span>
                            <div className="section-body">
                                <span className="">Yes</span>
                            </div>
                        </div>
                        <div className="data-card-section">
                            <span className="section-title">
                                Other Diagnosis
                            </span>
                            <div className="section-body">
                                <span className="">
                                    Protected -{' '}
                                    <i className="fw-light">see manifest</i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Exposures Card */}
                <div className="data-card exposure">
                    <div className="header">
                        <div className="header-text">Exposures</div>
                    </div>
                    <div className="body d-flex flex-column gap-4">
                        <div className="exposure-card">
                            <div className="exposure-card-header">
                                <span className="title">Tobacco</span>
                                <div className="datum">
                                    <span className="datum-title">
                                        Duration
                                    </span>
                                    <span className="datum-value">30 yrs</span>
                                </div>
                            </div>
                            <div className="exposure-card-body">
                                <div className="datum">
                                    <span className="datum-title">
                                        Frequency
                                    </span>
                                    <span className="datum-value">Daily</span>
                                </div>
                                <div className="datum">
                                    <span className="datum-title">
                                        Quantity
                                    </span>
                                    <span className="datum-value">
                                        1 pack / day
                                    </span>
                                </div>
                                <div className="datum">
                                    <span className="datum-title">
                                        Cessation
                                    </span>
                                    <span className="datum-value">10 yrs</span>
                                </div>
                            </div>
                        </div>

                        <div className="exposure-card">
                            <div className="exposure-card-header">
                                <span className="title">Alcohol</span>
                                <div className="datum">
                                    <span className="datum-title">
                                        Duration
                                    </span>
                                    <span className="datum-value">40 yrs</span>
                                </div>
                            </div>
                            <div className="exposure-card-body">
                                <div className="datum">
                                    <span className="datum-title">
                                        Frequency
                                    </span>
                                    <span className="datum-value">Social</span>
                                </div>
                                <div className="datum">
                                    <span className="datum-title">
                                        Quantity
                                    </span>
                                    <span className="datum-value">--</span>
                                </div>
                                <div className="datum">
                                    <span className="datum-title">
                                        Cessation
                                    </span>
                                    <span className="datum-value">10 yrs</span>
                                </div>
                            </div>
                        </div>

                        <div className="data-card-section">
                            <span className="section-title">
                                Other Exposures
                            </span>
                            <div className="section-body">
                                <span className="">
                                    Protected -{' '}
                                    <i className="fw-light">see manifest</i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};
