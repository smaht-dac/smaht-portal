'use strict';

import React, { useEffect } from 'react';
import url from 'url';
import _ from 'underscore';
import queryString from 'query-string';

import DefaultItemView from './DefaultItemView';
import {
    DotRouter,
    DotRouterTab,
} from '@hms-dbmi-bgm/shared-portal-components/es/components/ui/DotRouter';

import { bytesToLargerUnit } from '@hms-dbmi-bgm/shared-portal-components/es/components/util/value-transforms';
import { LocalizedTime } from '@hms-dbmi-bgm/shared-portal-components/es/components/ui/LocalizedTime';
import {
    FileOverviewTableController,
    FileOverviewTable,
} from './components/file-overview/FileOverviewTable';
import { SelectedItemsDownloadButton } from '../static-pages/components/benchmarking/BenchmarkingTable';
import { memoizedUrlParse } from '@hms-dbmi-bgm/shared-portal-components/es/components/util';

/**
 * Page containing the details of Items of type File
 */
export default class FileOverview extends DefaultItemView {
    getTabViewContents() {
        const initTabs = [];
        initTabs.push(FileView.getTabObject(this.props));
        return initTabs.concat(this.getCommonTabs()); // Add remainder of common tabs (Details, Attribution)
    }
}

const DataCard = ({ header = '', data = [] }) => {
    return (
        <div className="data-card">
            <div className="header">
                <span className="header-text">{header}</span>
            </div>
            <div className="body">
                {data.map(({ title, value = null }, i) => {
                    return (
                        <div className="datum" key={i}>
                            <span className="datum-title">{title}</span>
                            <span
                                className={
                                    'datum-value' +
                                    (value === null ? ' coming-soon' : '')
                                }>
                                {value ?? 'N/A'}
                            </span>
                        </div>
                    );
                })}
            </div>
        </div>
    );
};

const FileViewDataCards = ({ context = {} }) => {
    const file_properties = [
        {
            title: 'Annotated Name',
            getProp: (context = {}) =>
                context?.annotated_filename ?? context?.filename,
        },
        { title: 'Access', getProp: (context = {}) => context?.access_status },
        { title: 'UUID', getProp: (context = {}) => context?.uuid },
        {
            title: 'Data Format',
            getProp: (context = {}) => context?.file_format?.display_title,
        },
        {
            title: 'Size',
            getProp: (context = {}) =>
                bytesToLargerUnit(context?.file_summary?.file_size),
        },
        {
            title: 'MD5 Checksum',
            getProp: (context = {}) =>
                context?.content_md5sum || context?.md5sum,
        },
        {
            title: 'Public Release Date',
            getProp: (context = {}) => {
                return (
                    <LocalizedTime
                        timestamp={context?.file_status_tracking.released}
                        formatType="date-md"
                        dateTimeSeparator=" "
                    />
                );
            },
        },
    ];

    const data_information = [
        {
            title: 'Data Category',
            getProp: (context = {}) =>
                context?.data_generation_summary?.data_category?.join(', '),
        },
        {
            title: 'Data Type',
            getProp: (context = {}) =>
                context?.data_generation_summary?.data_type?.join(', '),
        },
        {
            title: 'Sequencing Center',
            getProp: (context = {}) =>
                context?.data_generation_summary?.sequencing_center,
        },
        {
            title: 'Generated By',
            getProp: (context = {}) =>
                context?.data_generation_summary?.submission_centers?.join(
                    ', '
                ),
        },
        {
            title: 'Experimental Assay',
            getProp: (context = {}) =>
                context?.data_generation_summary?.assays?.join(', '),
        },
        {
            title: 'Sequencing Platform',
            getProp: (context = {}) =>
                context?.data_generation_summary?.sequencing_platforms?.join(
                    ', '
                ),
        },
    ];

    const sample_information = [
        {
            title: 'Description',
            getProp: (context = {}) =>
                context?.sample_summary?.sample_descriptions?.join(', '),
        },
        {
            title: 'Study',
            getProp: (context = {}) =>
                context?.sample_summary?.studies?.join(', '),
        },
        {
            title: 'Donor ID',
            getProp: (context = {}) =>
                context?.sample_summary?.donor_ids?.join(', '),
        },
        {
            title: 'Tissue Type',
            getProp: (context = {}) =>
                context?.sample_summary?.tissues?.join(', '),
        },
        {
            title: 'Analyte',
            getProp: (context = {}) =>
                context?.sample_summary?.analytes?.join(', '),
        },
    ];

    return (
        <div className="data-cards-container">
            <DataCard
                header={'File Properties'}
                data={file_properties.map(({ title, getProp }) => {
                    return { title, value: getProp(context) };
                })}
            />
            <DataCard
                header={'Data Information'}
                data={data_information.map(({ title, getProp }) => {
                    return { title, value: getProp(context) };
                })}
            />
            <DataCard
                header={'Sample Information'}
                data={sample_information.map(({ title, getProp }) => {
                    return { title, value: getProp(context) };
                })}
            />
        </div>
    );
};

function ViewJSONAction({ href, children }) {
    const urlParts = _.clone(memoizedUrlParse(href));
    urlParts.search =
        '?' +
        queryString.stringify(_.extend({}, urlParts.query, { format: 'json' }));
    const viewUrl = url.format(urlParts);
    const onClick = (e) => {
        if (window && window.open) {
            e.preventDefault();
            window.open(
                viewUrl,
                'window',
                'toolbar=no, menubar=no, resizable=yes, status=no, top=10, width=400'
            );
        }
    };
    return React.cloneElement(children, { onClick });
}

const FileViewHeader = (props) => {
    const { context, session } = props;
    const { accession, status, description } = context;
    const selectedFile = new Map([[context['@id'], context]]);

    return (
        <div className="file-view-header">
            <div className="data-group data-row header">
                <h1 className="header-text">File Overview</h1>
                <SelectedItemsDownloadButton
                    id="download_tsv_multiselect"
                    className="btn btn-primary btn-sm mr-05 align-items-center download-file-button"
                    session={session}
                    selectedItems={selectedFile}
                    disabled={false}
                    analyticsAddItemsToCart>
                    <i className="icon icon-download fas mr-03" />
                    Download File
                </SelectedItemsDownloadButton>
            </div>
            <div className="data-group data-row">
                <div className="datum">
                    <span className="datum-title">File Accession </span>
                    <span className="vertical-divider">|</span>
                    <span>
                        <b className="accession">{accession}</b>
                    </span>
                </div>
                <div className="datum right-group">
                    <div className="status-group" data-status={status}>
                        <i className="icon icon-circle fas"></i>
                        <span className="status">
                            {status.charAt(0).toUpperCase() +
                                status.substring(1)}
                        </span>
                    </div>
                    <span className="vertical-divider">|</span>
                    <ViewJSONAction href={context['@id']}>
                        <a className="view-json">
                            <i className="icon icon-file-code far"></i>
                            <span>View JSON</span>
                        </a>
                    </ViewJSONAction>
                </div>
            </div>
            <div className="data-group data-row">
                <div className="datum description">
                    <span className="datum-title">Description </span>
                    <span className="vertical-divider">|</span>
                    <span
                        className={
                            'datum-value' + (description ? '' : ' text-gray')
                        }>
                        {description || 'Coming Soon'}
                    </span>
                </div>
            </div>
        </div>
    );
};

const AssociatedFilesTab = (props) => {
    const { context } = props;
    // Create a search href for file associated
    const fileSetUuids = context?.file_sets
        ?.map((fs) => fs.uuid)
        ?.join('&file_sets.uuid=');
    const associatedFilesSearchHref = `/search/?type=File&file_format.display_title=bam&uuid!=${props.context.uuid}&file_sets.uuid=${fileSetUuids}`;

    const DACGeneratedFiles =
        associatedFilesSearchHref + '&submission_centers.display_title=HMS DAC';

    const ExternallyGeneratedFiles =
        associatedFilesSearchHref +
        '&submission_centers.display_title!=HMS DAC';

    return (
        <div className="content associated-files">
            <h1 className="associated-files-header">Associated Files</h1>
            <hr />
            <FileOverviewTableController
                {...props}
                embeddedTableHeaderText="DAC Generated Files"
                associatedFilesSearchHref={DACGeneratedFiles}
            />
            <FileOverviewTableController
                {...props}
                embeddedTableHeaderText="Externally Generated Files"
                associatedFilesSearchHref={ExternallyGeneratedFiles}
            />
        </div>
    );
};

const QCOverviewTab = ({ context }) => {
    const bamLinks = [
        { name: 'BAMQC1', link: '/' },
        { name: 'BAMQC2', link: '/' },
        { name: 'BAMQC3', link: '/' },
    ];
    return <h2 className="tab-coming-soon">Coming soon</h2>;
};

const AnalysisInformationTab = ({ context }) => {
    return <h2 className="tab-coming-soon">Coming soon</h2>;
};

const FileViewTabs = (props) => {
    const { context, schemas, href } = props;

    useEffect(() => {}, [href]);

    return (
        <div className="tabs-container">
            <DotRouter
                href={href}
                navClassName=""
                isActive={true}
                prependDotPath="file-overview">
                <DotRouterTab
                    dotPath=".associated-files"
                    tabTitle="Associated Files"
                    arrowTabs={false}
                    default>
                    <AssociatedFilesTab {...props} />
                </DotRouterTab>
                <DotRouterTab
                    dotPath=".analysis-information"
                    tabTitle="Analysis Information"
                    arrowTabs={false}>
                    <AnalysisInformationTab />
                </DotRouterTab>
                <DotRouterTab
                    dotPath=".qc-overview"
                    tabTitle="QC Overview"
                    arrowTabs={false}>
                    <QCOverviewTab />
                </DotRouterTab>
            </DotRouter>
        </div>
    );
};

const FileViewTitle = (props) => {
    const { context, session, href } = props;

    const breadcrumbs = [
        { display_title: 'Home', href: '/' },
        { display_title: 'Data' },
        { display_title: 'Bechmarking Data' },
        { display_title: context?.dataset?.toUpperCase() || '' },
    ];

    return (
        <div className="file-view-title container-wide">
            <nav className="file-view-title-navigation">
                <ul className="breadcrumb-list">
                    {breadcrumbs.map(({ display_title, href }, i, arr) => {
                        return (
                            <li className="breadcrumb-list-item" key={i}>
                                <a
                                    className={
                                        'breadcrumb-list-item-link' +
                                        (href ? '' : ' no-link')
                                    }
                                    href={href}>
                                    {display_title}
                                </a>
                                {i < arr.length - 1 ? (
                                    <i className="icon icon-fw icon-angle-right fas"></i>
                                ) : null}
                            </li>
                        );
                    })}
                </ul>
            </nav>
            <h1 className="file-view-title-text">{context.display_title}</h1>
        </div>
    );
};

const FileViewUI = (props) => {
    const { context, session } = props;
    return (
        <div className="file-view-content">
            <FileViewHeader context={context} session={session} />
            <FileViewDataCards context={context} />
            <FileViewTabs {...props} />
        </div>
    );
};

const FileView = React.memo(function FileView(props) {
    const { context, session, href } = props;
    return (
        <div className="file-view">
            <FileViewTitle context={context} session={session} href={href} />
            <FileViewUI {...props} />
        </div>
    );
});

FileView.getTabObject = function (props) {
    return {
        tab: <span>File Overview</span>,
        key: 'file-overview',
        content: <FileView {...props} />,
    };
};
